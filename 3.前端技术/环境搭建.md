[toc]

# 环境搭建
## 组件列表
1. node 基础工具
2. babel 编译工具
3. webpack 打包工具
4. webpack-dev-server 开发服务器(自动编译打包)
5. react 开发库

## 安装node
根据系统选择以下几种安装方式
1. 官网下载二进制包，默认安装即可
2. OSX使用brew install node安装
3. CentOS使用yum install nodejs安装
4. Ubuntu使用apt-get install nodejs安装

## 安装构建工具
```
npm install webpack webpack-dev-server \
    babel-loader babel-core \
    babel-preset-react babel-preset-env \
    style-loader css-loader
```
其中
1. webpack打包工具
2. webpack-dev-server开发服务器
2. babel编译工具
3. babel-preset-react提供react转换规则
4. babel-preset-env提供(es2015|es2016|es2017)转换规则
5. css-loader处理css文件
6. style-loader插入style标签加载css

## 安装react
```
npm install react react-dom
```

### 配置文件
package.json
```
{
    "name": "react-demo",
    "version": "1.0.0",
    "description": "react demo project",
    "main": "index.js",
    "scripts": {
        "start": "webpack-dev-server -d --progress --colors",
        "build": "webpack -p --progress --colors",
        "build-dev": "webpack -w -d --progress --colors"
    },
    "author": "",
    "license": "ISC",
    "dependencies": {
        "antd": "^3.5.0",
        "babel-core": "^6.26.0",
        "babel-loader": "^7.1.4",
        "babel-plugin-import": "^1.7.0",
        "babel-polyfill": "^6.26.0",
        "babel-preset-env": "^1.6.1",
        "babel-preset-react": "^6.24.1",
        "css-loader": "^2.1.0",
        "style-loader": "^0.23.1",
        "html-webpack-plugin": "^3.2.0",
        "react": "^16.3.2",
        "react-dom": "^16.3.2",
        "webpack": "^4.6.0",
        "webpack-dev-server": "^3.1.3"
    },
    "devDependencies": {
        "webpack-cli": "^3.1.1"
    }
}
```

webpack.config.js
```
var path = require('path');
module.exports = {
    entry: {
        // 指定入口文件，key即为输出中的[name]
        // 单页应用可以不指定key，默认为main
        wallpaper: './src/wallpaper/index.js'
    },
    output: {
        // 输出文件名，多面应用可使用[name]-[hash:8]占位
        filename: 'dist/[name].js',
        // 文件的输出目录
        path: __dirname + '/public'),
        // 输出文件的web访问路径，eg. /或http://cdndomain/
        // 主要用于其它插件修改静态文件的访问路径
        publicPath: '/'
    },
    devServer: {
        // server根目录(可多个)，服务静态文件
        contentBase: [__dirname + '/public'],
        // 输出文件的web访问路径(输出目录是根目录的子目录时必须)
        // 只有这个路径下的文件才会被devServer动态服务
        publicPath: '/',
        port: 8080,
        // 运行server时打开浏览器
        open: true
        // 前后端同域时，用于开发时的请求代理
        proxy: {
            '/api': 'http://localhost'
        }
    },
    module: {
        rules: [{
            test: /\.jsx?$/,
            exclude: /node_modules/,
            use: {
                loader: 'babel-loader',
                options: {
                    presets: ['env', 'react'],
                    plugins: [
                        //babel-plugin-import用于antd等的按需加载
                        ["import", {
                            "libraryName": "antd",
                            "style": "css"
                        }]
                    ]
                }
            }
        }, {
            test: /\.css$/,
            use: ['style-loader', 'css-loader']
        }]
    },
    plugins: []
};
```

### 运行webpack
```
npm run start
```

## IDE配置
sublime + js 插件
1. CodeFormatter 代码格式化
    对js文件，设置e4x:true 忽略react中的xml代码，在syntaxes中增加'javascript (babel)'
2. Babel
    es6, react, jsx语法高亮，对js, jquery也有很好的支持
    菜单view -> Syntax -> Open all with current extension as... -> Babel -> JavaScript (Babel), 使用babel语法打开所有js文件

# npm
初始化配置文件package.json
```
npm init --yes
```

常用命令
```
// 本地安装
npm install <pkg> --save

// 全局安装
npm install -g <pkg>

// 更新
npm update

// 卸载
npm uninstall <pkg>

// 查看配置
npm config list -l

// 设置配置
npm config set <key> <val> [-g]

// 获取配置
npm config get <key> [-g]

// 配置源
npm config set registry https://registry.npm.taobao.org

// 查看源
npm config get registry

// 查看包
npm info <pkg>

// 搜索包
npm search <pattern>

// 安装列表
npm list --depth=0

// 运行命令(定义在scripts下)
npm run <cmd>
```


# babel
提供react/es6编译转换到es5的功能。

教程：http://www.ruanyifeng.com/blog/2016/01/babel.html

## 安装：
```
# webpack模块
npm install --save-dev babel-loader babel-core

# 客户端工具
npm install --save-dev babel-cli

# react转换规则
npm install --save-dev babel-preset-react

# es2015|es2016|es2017转换规则
npm install --save-dev babel-preset-env

# antd等的按需加载插件
npm install --save-dev babel-plugin-import
```

## cli配置文件.babelrc
```
{
    "presets": [
      "env",
      "react"
    ],
    "plugins": []
  }
```

## 全局安装使用方法
```
# 转码结果输出到标准输出
babel example.js

# 转码结果写入一个文件
babel example.js -o compiled.js

# 整个目录转码
babel src -d lib

# -s 参数生成source map文件
babel src -d lib -s
```

## 本地安装使用方法
改写package.json，通过`npm run build`调用
```
{
  // ...
  "devDependencies": {
    "babel-cli": "^6.0.0"
  },
  "scripts": {
    "build": "babel src -d lib"
  },
}
```

## babel-node
babel-cli自带babel-node命令，提供es6的交互执行环境，可直接运行es6脚本
```
# 运行es6脚本
babel-node es6.js
```
本地安装运行，修改package.json，然后运行'npm run es6'
```
{
  "scripts": {
    "es6": "babel-node es6.js"
  }
}
```

## babel-polyfill
babel默认只转es6新语法，不转换新的API，如Set, Maps, Promise等，详细清单参见babel-plugin-transform-runtime的definitions.js文件，需要引入babel-polyfill。

安装：`npm install babel-polyfill`

使用：添加`import 'babel-polyfill'`到入口顶部;

其余使用方法参见：https://www.jianshu.com/p/3b27dfc6785c

# webpack
## 文档
- 阮一峰webpack教程：https://github.com/ruanyf/webpack-demos
- 中文文档：https://www.webpackjs.com/concepts/
- 官方文档：https://webpack.js.org/configuration/

## 常用选项
- webpack – building for development
- webpack -p – building for production (minification)
- webpack -w – for continuous incremental building
- webpack -d – including source maps
- webpack --colors – making building output pretty
- webpack --progress - print compilation progress in percentage

## entry(输入)
指定入口文件，可以是单页，也可以是多页
```
// 单页(简写)
module.exports = {
    entry: './path/to/entry/file.js'
}

// 单页
module.exports = {
    entry: {
        main: './path/to/entry/file.js'
    }
}

// 多页
module.exports = {
    entry: {
        page1: './path/to/entry/page1.js',
        page2: './path/to/entry/page2.js',
        page3: './path/to/entry/page3.js'
    }
}
```

## output(输出)
最小配置项：输出目录(path)和文件名(filename)
```
// 单页
// path: 指定bundle文件输出目录
// publicPath: 指定bundle的web访问路径，
// 可以是当前域名下的路径，也可以是cdn路径
module.exports = {
    entry: './path/to/entry/file.js',
    output: {
        filename: 'dist/bundle.js',
        path: __dirname + '/public',
        publicPath: '/',
        publicPath: 'http://xxx.cdn.com/'
    }
}

// 多页(需要使用文件占位符)
// [name]: entry中的key
// [hash]: 输出文件的hash, 可以指定取多少位
module.exports = {
    entry: {
        page1: './path/to/entry/page1.js',
        page2: './path/to/entry/page2.js',
        page3: './path/to/entry/page3.js'
    },
    output: {
        filename: '[name]-[hash:8].js',
        path: './path/to/output'
    }
}
```

## mode(模式)
指定当前环境：development和production

webpack默认调用使用development，使用-p选项指定为production
```
module.exports = {
    mode: 'production'
}
```

## loader(加载器)
指定源码编译工具，可以`module.rules`中指定多个
```
// test: 指定文件过滤模式
// exclude: 指定文件排除模式
// use: 使用当些loader，单个或多个(从右向左执行)
module.exports = {
    module: {
        rules: [{
            test: /\.jsx?$/,
            exclude: /node_modules/,
            use: {
                loader: 'babel-loader',
                options: {
                    presets: ['env', 'react'],
                    plugins: [
                        ["import", {
                            "libraryName": "antd",
                            "style": "css"
                        }]
                    ]
                }
            }
        }, {
            test: /\.css$/,
            use: ['style-loader', 'css-loader']
        }]
    }
}
```
babel-plugin-import: 用于antd等的按需加载的babel插件

css-loader: 处理css文件

style-loader: 增加在页面中插入<style>标签的js逻辑

url-loader: 图片到img标签的处理
```
// 下例中处理png和jpg图片，当图片小于8K时，图片会转换成data url
// <img src="data:image/png;base64,iVBOR...uQmCC">
// <img src="4853ca667a2b8b8844eb2693ac1b2578.png">
{
    test: /\.(png|jpg)$/,
    use: [{
        loader: 'url-loader',
        options: {
          limit: 8192
        }
    }]
}
```

## plugins(插件)
HtmlwebpackPlugin：html模板插件，可以设置多个
```
// html默认输出到output.path下，输出html中通过相对路径引用bundle文件
// 当指定了output.publicPath时，输出html中通过publicPath引用bundle文件
// filename可以包含路径，但不在输出目录时不能通过devServer动态解析
// 多页应用每个entry对应一个HtmlWebpackPlugin, 需要设置chunks属性
plugins: [
    new HtmlWebpackPlugin({
        template: 'backend/template.html',
        filename: 'backend.html',
        hash: true
    })
]
```

CommonsChunkPlugin：抽取公共模块或vendor代码
```
{
    plugins: [
    new webpack.optimize.CommonsChunkPlugin({
        name: "commons", //公共模块名称
        filename: "commons.js", //输出文件名
    })
  ]
}
```

## code split(按需加载)
```
TODO require.ensure
```

## externals(引入外部变量)
```
// var $ = require('jquery');
// 通过import/requery导入外部全局变量
{
    externals: {
        jquery: 'jQuery',
        data: 'data'
    }
}
```


# webpack-dev-server
提供一个http服务器，监控文件变化，并实时编译，通过webpack-dev-server触发的编译会包含webpack-dev-server的相关模块，页面使用websocket获取文件更新，webpack-dev-server的编译输出是在内存中，而不是webpack的output.path。

用于开发环境自动打包与更新，调用方式：
- 直接调用：node_modules/.bin/webpack-dev-server --inline
- npm run：scripts.start: 'webpack-dev-server -d --progress --progress --color'

配置文件
```
devServer: {
    contentBase: __dirname + "/public", //根目录，可多个
    // 输出文件的web访问路径，输出目录是根目录的子目录时必须
    publicPath: '/', 
    port: 8080, //监听端口
    open: true, //启动devserver时打开浏览器
    inline: true, //使用inline模式[默认]
    color: true, //同命令行--color
    progress: true, //同命令行--progress
    watchContentBase: true, //ContentBase文件变化强制刷新页面
    proxy: {
        //当前后端在同一个域名下时，用于dev时代理到后端接口
        //eg. 访问/api/user时代理到http://localhost/api/user
        '/api': 'http://localhost'
    }
}
```
